{% extends "base.html" %}
{% block title %}Donor Dashboard{% endblock %}

{% block content %}
<div class="hm" style="margin-top: 20px;"><div class="container-locked">

  <h2>Donor Dashboard</h2>

  <style>
    .hm .kpis{display:grid;gap:14px;grid-template-columns:repeat(4,minmax(0,1fr));margin-bottom:12px}
    .hm .kpi-card{background:#0e1627;border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;gap:12px;align-items:center}
    .hm .kpi-ico{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#111c31;border:1px solid var(--border);font-size:1.1rem}
    .hm .kpi-meta{color:#94a3b8;font-weight:600;font-size:.9rem}
    .hm .kpi-val{font-size:1.6rem;font-weight:800;letter-spacing:.3px}
    .hm .sub{color:#94a3b8;font-size:.85rem}
    .hm .muted{color:#94a3b8}

    .hm .badge{padding:.2rem .5rem;border-radius:999px;font-weight:700;font-size:.75rem;border:1px solid var(--border)}
    .hm .b-pending{background:#302110;color:#fbbf24;border-color:#b45309}
    .hm .b-approved{background:#0f2a18;color:#86efac;border-color:#15803d}
    .hm .b-partial{background:#122433;color:#93c5fd;border-color:#2563eb}
    .hm .b-expired{background:#2a1114;color:#fca5a5;border-color:#b91c1c}
    .hm .b-complete{background:#112129;color:#a5b4fc;border-color:#4f46e5}

    .hm table.table{width:100%;border-collapse:collapse}
    .hm .table th,.hm .table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    .hm .tinybar{height:8px;background:#0f172a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .hm .tinybar > span{display:block;height:100%;background:#3b82f6}

    .hm .grid-12{display:grid;gap:14px;grid-template-columns:repeat(12,minmax(0,1fr))}
    .hm .span-12{grid-column:span 12}
    .hm .card{background:#0e1627;border:1px solid var(--border);border-radius:14px;padding:16px}
    .hm .btn{display:inline-block;padding:10px 18px;border-radius:10px;background:#3b82f6;color:#fff;text-decoration:none}
    .hm .cta-center{display:flex;justify-content:center;margin:10px 0 18px}

    /* star bars */
    .hm .stars{position:relative;display:inline-block;line-height:1}
    .hm .stars .base{color:#334155}
    .hm .stars .fill{position:absolute;left:0;top:0;white-space:nowrap;overflow:hidden;color:#f5c518}
    @media (max-width:900px){ .hm .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
  </style>

  <!-- KPI row 1 -->
  <div class="kpis">
    <div class="kpi-card"><div class="kpi-ico">ğŸ“¦</div><div><div class="kpi-meta">Posted</div><div class="kpi-val">{{ totals.posted }}</div></div></div>
    <div class="kpi-card"><div class="kpi-ico">âœ…</div><div><div class="kpi-meta">Approved / In Stock</div><div class="kpi-val">{{ totals.approved }}</div><div class="sub">{{ totals.approval_rate }}% approval</div></div></div>
    <div class="kpi-card"><div class="kpi-ico">â³</div><div><div class="kpi-meta">Pending Review</div><div class="kpi-val">{{ totals.pending }}</div></div></div>
    <div class="kpi-card"><div class="kpi-ico">ğŸ•’</div><div><div class="kpi-meta">Expired</div><div class="kpi-val">{{ totals.expired }}</div></div></div>
  </div>

  <!-- KPI row 2 (includes Ratings card) -->
  <div class="kpis">
    <div class="kpi-card"><div class="kpi-ico">ğŸ‘¥</div><div><div class="kpi-meta">People Offered</div><div class="kpi-val">{{ totals.offered_people }}</div></div></div>
    <div class="kpi-card"><div class="kpi-ico">ğŸ½ï¸</div><div><div class="kpi-meta">People Served</div><div class="kpi-val">{{ totals.served_people }}</div><div class="sub">{{ totals.utilization }}% of offered</div></div></div>
    <div class="kpi-card"><div class="kpi-ico">âœ…</div><div><div class="kpi-meta">Completed / Depleted</div><div class="kpi-val">{{ totals.completed }}</div></div></div>
    <div class="kpi-card">
      <div class="kpi-ico">â­</div>
      <div>
        <div class="kpi-meta">Average Ratings</div>
        <div class="sub">NGOs</div>
        <div class="stars" aria-label="NGO rating {{ avg_ngo|default:0 }}/5">
          <span class="base">â˜…â˜…â˜…â˜…â˜…</span>
          <span class="fill" style="width: {{ avg_ngo_pct }}%">â˜…â˜…â˜…â˜…â˜…</span>
        </div>
        <span class="sub" style="margin-left:6px">{{ avg_ngo|default:"â€“" }}/5</span>
        <div class="sub" style="margin-top:4px">Receivers</div>
        <div class="stars" aria-label="Receiver rating {{ avg_recv|default:0 }}/5">
          <span class="base">â˜…â˜…â˜…â˜…â˜…</span>
          <span class="fill" style="width: {{ avg_recv_pct }}%">â˜…â˜…â˜…â˜…â˜…</span>
        </div>
        <span class="sub" style="margin-left:6px">{{ avg_recv|default:"â€“" }}/5</span>
      </div>
    </div>
  </div>

  <!-- Single Post button (only here) -->
  <div class="cta-center">
    <a class="btn" href="{% url 'donor_food_create' %}">Post New Food</a>
  </div>

  <!-- Recent posts -->
<div class="card span-12">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
    <h3 style="margin:0">Recent Posts</h3>

    <!-- Filter pills -->
    <style>
      .hm .pills{display:flex; gap:8px; flex-wrap:wrap}
      .hm .pill{
        padding:.35rem .7rem; border:1px solid var(--border); border-radius:999px;
        color:#cbd5e1; text-decoration:none; font-weight:700; font-size:.85rem;
        background:#0e1627;
      }
      .hm .pill.active{background:#3b82f6; color:#fff; border-color:#3b82f6}
      .hm .pill .count{opacity:.85; margin-left:6px}
    </style>
    <div class="pills">
      <a class="pill {% if current_filter == 'all' %}active{% endif %}" href="?filter=all">All
        <span class="count">({{ filter_counts.all }})</span></a>
      <a class="pill {% if current_filter == 'posted' %}active{% endif %}" href="?filter=posted">Posted
        <span class="count">({{ filter_counts.posted }})</span></a>
      <a class="pill {% if current_filter == 'delivered' %}active{% endif %}" href="?filter=delivered">Delivered
        <span class="count">({{ filter_counts.delivered }})</span></a>
      <a class="pill {% if current_filter == 'expired' %}active{% endif %}" href="?filter=expired">Expired
        <span class="count">({{ filter_counts.expired }})</span></a>
    </div>
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>ID</th><th>Item</th><th>Status</th><th>Served</th><th>Qty</th><th>Expires</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for f in foods %}
        <tr>
          <td><a href="{% url 'donor_food_detail' f.id %}">#{{ f.id }}</a></td>
          <td>{{ f.item_name }}</td>
          <td>
            {% if f.status == "PENDING" %}
              <span class="badge b-pending">Pending</span>
            {% elif f.status == "ACCEPTED" %}
              <span class="badge b-approved">Approved</span>
            {% elif f.status == "PARTIAL" %}
              <span class="badge b-partial">Partial</span>
            {% elif f.status == "EXPIRED" %}
              <span class="badge b-expired">Expired</span>
            {% elif f.inventory_remaining == 0 %}
              <span class="badge b-complete">Depleted</span>
            {% else %}
              <span class="badge">{{ f.status }}</span>
            {% endif %}
          </td>
          <td style="min-width:160px">
            <div class="tinybar" title="{{ f.served|default:0 }}/{{ f.quantity_people }}">
              <span style="width: {{ f.served_pct|floatformat:0 }}%"></span>
            </div>
            <div class="muted" style="margin-top:4px">{{ f.served|default:0 }}/{{ f.quantity_people }}</div>
          </td>
          <td>{{ f.quantity_people }}</td>
          <td>{{ f.expires_at|date:"Y-m-d H:i" }}</td>
          <td class="actions">
            <a class="btn" href="{% url 'donor_food_detail' f.id %}">View</a>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">No items for this filter.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>


</div></div>
{% endblock %}
